500000
TMPDIR = /scratch/global/yangjunjie/phi/546307/
PYSCF_TMPDIR = /scratch/global/yangjunjie/phi/546307/
#INFO: **** input file is /home/yangjunjie/work/thc-least-square-in-supercell/phi-in-supercell.py ****
import os, sys
import numpy, scipy
import scipy.linalg
import pyscf
from pyscf.pbc import gto

tmpdir = pyscf.lib.param.TMPDIR
stdout = sys.stdout

cell = pyscf.pbc.gto.Cell()
cell.atom  = 'He 2.0000 2.0000 2.0000; He 2.0000 2.0000 6.0000'
cell.basis = '321g'
cell.a = numpy.diag([4.0000, 4.0000, 8.0000])
cell.unit = 'bohr'
cell.verbose = 5
cell.stdout = stdout
cell.build()

nao = cell.nao_nr()

kmesh = numpy.asarray([4] * 3)
vk = kpts = cell.make_kpts(kmesh)
nk = len(vk)

from pyscf.pbc.tools.k2gamma import translation_vectors_for_kmesh
vr = rpts = translation_vectors_for_kmesh(cell, kmesh=kmesh, wrap_around=False)
nr = len(vr)

scell = pyscf.pbc.tools.pbc.super_cell(cell.copy(deep=True), kmesh, wrap_around=False)

gmesh = numpy.asarray([5] * 3)
ng = numpy.prod(gmesh)

coord0 = cell.gen_uniform_grids(gmesh, wrap_around=False)
coord1 = coord0[None, :] + vr[:, None]
coord1 = coord1.reshape(nr * ng, 3)

phi0 = scell.pbc_eval_gto('GTOval', coord0)
phi0 = phi0.reshape(ng, nr, nao)

phi = scell.pbc_eval_gto('GTOval', coord1)
phi = phi.reshape(nr, ng, nr, nao) # , nr)

theta = numpy.einsum('kx,rx->kr', vk, vr)
phase = numpy.exp(-1j * theta)

phi_k_1 = numpy.einsum('grm,kr->kgm', phi0, phase)
phi_k_2 = numpy.einsum("rgsm,kr,ls->kglm", phi, phase, phase) / nr


for k1k2 in range(nk * nk):
    k1, k2 = divmod(k1k2, nk)
    phi2 = phi_k_2[k1, :, k2, :]

    if k1 != k2:
        err = abs(phi2).max()
        
        if not abs(phi2).max() < 1e-8:
            print(f"err = {err:6.2e}, k1 = {k1}, k2 = {k2}")
            print(phi2[:10, :])
            assert 1 == 2

    else:
        phi_ = cell.pbc_eval_gto('GTOval', coord0, kpt=vk[k1])
        phi_ = numpy.asarray(phi_)

        err = abs(phi_ - phi2).max()
        if not err < 1e-8:
            print(f"err = {err:6.2e}, k1 = {k1}, k2 = {k2}")
            print(phi_[:10, :])
            print(phi2[:10, :])
            assert 1 == 2
            
        err = abs(phi_k_1[k1, :] - phi2).max()
        if not err < 1e-8:
            print(f"err = {err:6.2e}, k1 = {k1}, k2 = {k2}")
            print(phi_k_1[k1, :10, :])
            print(phi2[:10, :])
            assert 1 == 2
            
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='pauling029', release='3.10.0-327.36.3.el7.x86_64', version='#1 SMP Thu Oct 20 04:56:07 EDT 2016', machine='x86_64')  Threads 28
Python 3.10.14 | packaged by conda-forge | (main, Mar 20 2024, 12:45:18) [GCC 12.3.0]
numpy 1.26.4  scipy 1.14.0  h5py 3.11.0
Date: Sun Aug 11 22:13:56 2024
PySCF version 2.6.2
PySCF path  /home/yangjunjie/packages/pyscf/py310-pyscf
GIT HEAD (branch master) ca8c7c1680defdfee2380eda3af3a28d9fb375cb

[ENV] PYSCF_MAX_MEMORY 500000
[ENV] PYSCF_TMPDIR /scratch/global/yangjunjie/phi/546307/
[CONFIG] conf_file /home/yangjunjie/.pyscf_conf.py
[INPUT] verbose = 5
[INPUT] max_memory = 500000 
[INPUT] num. atoms = 2
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = bohr
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 He     1.058354421840   1.058354421840   1.058354421840 AA    2.000000000000   2.000000000000   2.000000000000 Bohr   0.0
[INPUT]  2 He     1.058354421840   1.058354421840   3.175063265520 AA    2.000000000000   2.000000000000   6.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] He
[INPUT] 0    0    [2    /1   ]  13.6267           0.17523
                                1.99935           0.893483
[INPUT] 0    0    [1    /1   ]  0.382993             1

Ewald components = 0.0736089428601405, -3.00008278569653, 0.08917636335577
nuclear repulsion = -2.83729747948062
number of shells = 4
number of NR pGTOs = 6
number of NR cGTOs = 4
basis = 321g
ecp = {}
CPU time:         3.50
lattice vectors  a1 [4.000000000, 0.000000000, 0.000000000]
                 a2 [0.000000000, 4.000000000, 0.000000000]
                 a3 [0.000000000, 0.000000000, 8.000000000]
dimension = 3
low_dim_ft_type = None
Cell volume = 128
rcut = 11.574358756914298 (nimgs = [3 3 2])
lattice sum = 173 cells
precision = 1e-08
pseudo = None
ke_cutoff = 1151.1727246754501
    = [ 63  63 125] mesh (496125 PWs)
err = 4.11e-01, k1 = 1, k2 = 1
[[1.62945590e-10+0.00000000e+00j 1.40083307e-02-6.66450525e-08j
  7.48315482e-27-1.22209193e-10j 6.66454488e-08-1.40083307e-02j]
 [3.51835966e-07+0.00000000e+00j 6.09677674e-02-1.58909733e-11j
  7.49638915e-24-2.02803801e-18j 3.90418833e-05-4.52953830e-04j]
 [2.72212267e-08+0.00000000e+00j 3.73418350e-02+1.31987631e-09j
  7.54648980e-14-1.20591901e-30j 3.21864055e-03-2.06111842e-06j]
 [7.54648980e-14+0.00000000e+00j 3.21864055e-03+2.06111842e-06j
  2.72212267e-08-2.56939002e-47j 3.73418350e-02-1.31987685e-09j]
 [7.49638915e-24+0.00000000e+00j 3.90418833e-05+4.52953830e-04j
  3.51835966e-07-1.96160590e-68j 6.09677674e-02-1.18944766e-13j]
 [1.36106511e-08+0.00000000e+00j 2.02811725e-02-9.64886082e-08j
  8.33410859e-25-1.36106322e-08j 9.64888591e-08-2.02811725e-02j]
 [2.93884393e-05+0.00000000e+00j 8.82687479e-02-2.30069282e-11j
  6.26164458e-22-2.25865820e-16j 5.65245916e-05-6.55783690e-04j]
 [2.27375665e-06+0.00000000e+00j 5.40632725e-02+1.91090857e-09j
  6.30349306e-12-1.34305119e-28j 4.65992743e-03-2.98407422e-06j]
 [6.30349306e-12+0.00000000e+00j 4.65992743e-03+2.98407422e-06j
  2.27375665e-06-2.86157055e-45j 5.40632725e-02-1.91090936e-09j]
 [6.26164458e-22+0.00000000e+00j 5.65245916e-05+6.55783690e-04j
  2.93884393e-05-2.18467171e-66j 8.82687479e-02-1.72207480e-13j]]
[[ 2.54602484e-12-9.04214541e-27j -1.23854106e-14-6.19280726e-14j
   9.74369118e-28-5.72855590e-12j  3.59442288e-19-1.73396657e-14j]
 [ 0.00000000e+00-2.15437395e-23j -5.92958842e-14+1.84081249e-15j
   1.93997205e-35-1.05626980e-19j -5.80444925e-12-5.60884733e-16j]
 [-4.96049874e-23-1.66681941e-24j -3.30294060e-14+1.93941834e-16j
   1.17913903e-15-4.53301686e-30j  5.69592388e-16-2.75095637e-18j]
 [ 2.94784758e-16-4.58479157e-30j -3.13040338e-15+6.12862153e-13j
  -2.58493941e-26-1.66681941e-24j -3.30247982e-15-2.28816167e-18j]
 [-2.92827701e-26-4.55435344e-40j -1.72590904e-17-1.60193468e-16j
   0.00000000e+00-2.15437395e-23j  2.69515313e-14-3.73319916e-18j]
 [ 0.00000000e+00-8.33411870e-25j -3.84263205e-14-1.97018433e-13j
   2.70755408e-31-1.47392379e-15j  4.56890523e-19-7.68124984e-14j]
 [-6.36506212e-13-1.79952275e-21j -5.15538133e-16-5.28138755e-17j
  -2.20405191e-39-2.44594816e-23j  2.13751729e-16-1.24602034e-15j]
 [-1.95545497e-21-1.39227422e-22j -1.02441384e-13-3.31924047e-18j
   1.36523515e-19-3.85977611e-28j  1.59038906e-17-1.15910451e-17j]
 [-1.36523496e-19-3.85977580e-28j  8.77934742e-15-2.28286478e-17j
  -6.28657266e-23-1.39227428e-22j  2.04443016e-13-3.31043967e-18j]
 [ 0.00000000e+00-3.83415050e-38j -2.72374032e-19-2.47709718e-15j
   6.36506211e-13-1.79952252e-21j  2.50450702e-16-5.40490231e-18j]]
Traceback (most recent call last):
  File "/home/yangjunjie/work/thc-least-square-in-supercell/phi-in-supercell.py", line 72, in <module>
    assert 1 == 2
AssertionError
